---
- name: Restore router configuration
  hosts: all
  gather_facts: no

  vars:
    ansible_network_os: cisco.ios.ios
    ansible_user: "{{ router_user }}"
    ansible_password: "{{ router_pass }}"
    ansible_connection: ansible.netcommon.network_cli
    # กำหนดชื่อไฟล์บนเราเตอร์
    remote_temp_filename: "ansible_restore_temp.cfg"

  tasks:
    - name: Create a temporary file with the config content (on worker)
      ansible.builtin.copy:
        content: "{{ config_content }}"
        dest: "/tmp/restore_config_{{ inventory_hostname }}.tmp"
      register: local_temp_file

    # --- Task ที่เพิ่มเข้ามา ---
    - name: Check if SCP server is enabled
      cisco.ios.ios_command:
        commands:
          - "show running-config | include ip scp server enable"
      register: scp_check

    - name: Enable SCP server if it is not enabled
      cisco.ios.ios_config:
        lines:
          - "ip scp server enable"
      # 'when' คือเงื่อนไข: ให้ทำงานเมื่อผลลัพธ์ของ scp_check (stdout[0]) ไม่มีคำว่า "ip scp server enable"
      when: "'ip scp server enable' not in scp_check.stdout[0]"
    # --- จบส่วนที่เพิ่ม ---

    - name: Upload config file to router's flash
      # Task นี้ควรจะทำงานได้แล้ว
      ansible.netcommon.net_put:
        src: "{{ local_temp_file.dest }}"
        dest: "flash:/{{ remote_temp_filename }}"
      register: upload_result

    - name: Restore configuration using 'configure replace'
      cisco.ios.ios_command:
        commands:
          - "configure replace flash:/{{ remote_temp_filename }} force"
      register: restore_result

    - name: Clean up config file from router's flash
      cisco.ios.ios_command:
        commands:
          - "delete /force flash:/{{ remote_temp_filename }}"
      register: cleanup_remote_result

    - name: Clean up the temporary file (from worker)
      ansible.builtin.file:
        path: "{{ local_temp_file.dest }}"
        state: absent