<html>
    <link rel="stylesheet" href="/static/style.css" />
    <body>
        <div style="margin-bottom: 15px;">
            <a href="{{ url_for('main') }}"><button>Home</button></a>
        </div>
        <hr>
    <h1>Router: {{ router_ip }}</h1>
    <h2>Interface Status</h2>
<table border="1">
            <thead>
                <tr>
                    <th>timestamp</th>
                    <th>interface</th>
                    <th>ipaddress</th>
                    <th>status</th>
                    <th>protocol</th>
                    <th>Actions</th> </tr>
            </thead>
<tbody>
                {% if interface_data %}
                    {% for i in interface_data.interfaces %}
                    <tr>
                        <td>{{ interface_data.timestamp }}</td>
                        <td>{{ i.interface }}</td>
                        <td>{{ i.ip_address }}</td>
                        <td>{{ i.status }}</td>
                        <td>{{ i.proto }}</td>
                        <td>
                            <a href="{{ url_for('config_interface', ip=router_ip, interface_name=i.interface.replace('/', '-')) }}">
                                <button>Configure</button>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
                </tbody>
        </table>
    <br>
    <hr>
    <h2>Current DNS Servers</h2>
    <a href="{{ url_for('config_dns', ip=router_ip) }}" style="margin-left: 10px;">
        <button>Configure DNS</button>
    </a>
    {% if current_dns %}
        <ul>
        {% for server in current_dns %}
            <li>{{ server }}
                <form method="POST" action="{{ url_for('delete_dns_server', ip=router_ip) }}" style="display:inline; margin-left: 10px;" onsubmit="return confirm('Are you sure you want to delete DNS server \'{{ server }}\'?');">
                    <input type="hidden" name="dns_server" value="{{ server }}">
                    <button type="submit" style="font-size: 0.8em; padding: 2px 5px; background-color: #dc3545; color: white;">Delete</button>
                </form>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No DNS servers are currently configured on this router.</p>
    {% endif %}
    <hr>
    <h2>DHCP Configuration</h2>
    <a href="{{ url_for('config_dhcp', ip=router_ip) }}" style="margin-left: 10px;">
        <button>Configure DHCP</button>
    </a>
    <h4>Excluded IP Addresses</h4>
    {% if dhcp_excluded %}
        <ul>
        {% for address_range in dhcp_excluded %}
            <li>{{ address_range }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No excluded addresses configured.</p>
    {% endif %}

    <h4>DHCP Pools</h4>
    {% if dhcp_pools %}
    <table border="1">
        <thead>
            <tr>
                <th>Pool Name</th>
                <th>Network</th>
                <th>Default Gateway</th>
                <th>DNS Servers</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for pool in dhcp_pools %}
            <tr>
                <td>{{ pool.name }}</td>
                <td>{{ pool.network | default('N/A') }}</td>
                <td>{{ pool.default_router | default('N/A') }}</td>
                <td>{{ pool.dns_servers | default('N/A') }}</td>
                <td>
                    <a href="{{ url_for('edit_dhcp', ip=router_ip, pool_name=pool.name) }}">
                        <button>Edit</button>
                    </a>
                    <form method="POST" action="{{ url_for('delete_dhcp', ip=router_ip) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete the DHCP pool \'{{ pool.name }}\'?');">
                        <input type="hidden" name="pool_name" value="{{ pool.name }}">
                        <button type="submit" style="background-color: #dc3545; color: white;">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No DHCP pools are currently configured on this router.</p>
    {% endif %}
    <hr>
    <h2>Backup History</h2>
        <form id="backupForm" method="POST" action="/router/{{ router_ip }}/backup">
        <button type="submit">Backup Configuration</button>
        <span id="backupStatus" style="display:none; margin-left: 10px;">Backup in progress... Please wait.</span>
    </form>

    <script>
        document.getElementById('backupForm').addEventListener('submit', function(event) {
            // หยุดการส่งฟอร์มแบบปกติ
            event.preventDefault();

            // แสดงสถานะ "in progress"
            document.getElementById('backupStatus').style.display = 'inline';
            // ปิดการใช้งานปุ่มเพื่อป้องกันการกดซ้ำ
            this.querySelector('button').disabled = true;

            // ส่งคำขอ backup ไปเบื้องหลัง
            fetch(this.action, { method: 'POST' });

            // หน่วงเวลา 10 วินาที แล้วค่อยรีเฟรชหน้าเว็บ
            setTimeout(function() {
                location.reload();
            }, 10000); // 10000 milliseconds = 10 seconds
        });
    </script>
    <table border="1">
        <thead>
            <tr>
                <th>Backup Timestamp</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for backup in backup_data %}
            <tr>
                <td>{{ backup.timestamp }}</td>
                <td>
                    <a href="/backup/{{ backup._id }}/view" style="margin-right: 5px;">
                        <button>View</button>
                    </a>
                    <a href="/backup/{{ backup._id }}/download" style="margin-right: 5px;">
                        <button>Download</button>
                    </a>
                    <form method="POST" action="/backup/{{ backup._id }}/restore" style="display:inline;" onsubmit="return confirm('Are you sure you want to restore this configuration? This can have serious consequences.');">
                        <button type="submit" style="background-color: #dc3545; color: white;">Restore</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        <script>
        // ใช้ URLSearchParams เพื่ออ่านค่าจาก URL
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');

        // ตรวจสอบว่ามี status=restore_sent ส่งมาหรือไม่
        if (status === 'restore_sent') {
            // ถ้ามี ให้แสดง pop-up
            alert('Restore job has been sent successfully! The configuration will be applied shortly.');
            
            // ล้าง URL ให้กลับเป็นปกติ (เพื่อไม่ให้ pop-up ขึ้นมาอีกตอน refresh)
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        else if (status === 'config_sent') {
            alert('Interface configuration job has been sent successfully! The changes will be applied shortly.');
            // ล้าง URL ให้กลับเป็นปกติ
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        else if (status === 'dns_config_sent') {
            alert('DNS configuration job has been sent successfully! The changes will be applied shortly.');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        else if (status === 'dns_delete_sent') {
            alert('DNS server deletion job has been sent! The changes will be applied shortly.');
            // หน่วงเวลาก่อนรีเฟรช
            setTimeout(function() {
                window.location.href = window.location.pathname;
            }, 5000); // 5 วินาที
        }
        else if (status === 'dhcp_config_sent') {
            alert('DHCP configuration job has been sent successfully! The changes will be applied shortly.');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        else if (status === 'dhcp_delete_sent') {
            alert('DHCP pool deletion job has been sent successfully! The changes will be applied shortly.');
            // หน่วงเวลาเล็กน้อยก่อนรีเฟรช เพื่อให้เวลา Worker ทำงาน
            setTimeout(function() {
                window.location.href = window.location.pathname;
            }, 5000); // 5 วินาที
        }
        else if (status === 'dhcp_edit_sent') {
            alert('DHCP pool update job has been sent successfully! The changes will be applied shortly.');
            setTimeout(function() {
                window.location.href = window.location.pathname;
            }, 5000); // 5 วินาที
        }
    </script>
    </body>
</html>